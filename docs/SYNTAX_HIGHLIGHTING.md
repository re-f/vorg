# VOrg 语法高亮功能

VOrg 扩展提供了完整的 Org-mode 语法高亮功能，包括 TextMate 语法定义和增强的装饰器高亮。**语法高亮会自动跟随 VS Code 的当前主题**，为深色和浅色主题提供最佳的视觉体验。

## 功能特性

### 基础语法高亮（TextMate 语法）

VOrg 使用 TextMate 语法定义 (`org.tmLanguage.json`) 提供基础的语法高亮，支持：

#### 标题层级
- **1-6 级标题**：不同颜色和字体加粗
- **TODO 状态**：TODO、DONE、NEXT、WAITING、CANCELLED
- **标签支持**：标题后的 `:tag1:tag2:` 格式

#### 文本格式
- **粗体**：`*粗体*`
- **斜体**：`/斜体/`
- **下划线**：`_下划线_`
- **删除线**：`+删除线+`
- **代码**：`=代码=` 和 `~等宽字体~`

#### 列表
- **无序列表**：`-`、`+`、`*` 开头
- **有序列表**：数字和字母编号
- **任务列表**：`[ ]`、`[X]`、`[-]` 复选框

#### 代码块（支持真正的语法高亮）
- **语言标识**：`#+BEGIN_SRC language`
- **参数支持**：`#+BEGIN_SRC python -n -r`
- **真正的语法高亮**：根据指定语言进行实际的代码语法高亮

**支持的编程语言**：
- **Python** (`python`) - 完整的Python语法高亮
- **JavaScript** (`javascript`, `js`) - ES6+语法支持
- **TypeScript** (`typescript`, `ts`) - 类型注解和接口高亮
- **Java** (`java`) - 面向对象语法高亮
- **C** (`c`) - C语言语法高亮
- **C++** (`cpp`, `c++`) - 现代C++语法支持
- **Rust** (`rust`) - Rust语法和宏支持
- **Go** (`go`) - Go语言语法高亮
- **Shell** (`shell`, `bash`, `sh`) - Shell脚本语法
- **SQL** (`sql`) - 数据库查询语法
- **JSON** (`json`) - JSON格式高亮
- **YAML** (`yaml`, `yml`) - YAML配置文件高亮
- **HTML** (`html`) - HTML标记语法
- **CSS** (`css`) - CSS样式语法

**使用示例**：
```org
#+BEGIN_SRC python
def hello_world():
    print("Hello, World!")
#+END_SRC

#+BEGIN_SRC javascript
const greeting = "Hello from JavaScript";
console.log(greeting);
#+END_SRC
```

#### 其他语法块
- **引用块**：`#+BEGIN_QUOTE` / `#+END_QUOTE`
- **示例块**：`#+BEGIN_EXAMPLE` / `#+END_EXAMPLE`
- **导出块**：`#+BEGIN_EXPORT` / `#+END_EXPORT`
- **诗歌块**：`#+BEGIN_VERSE` / `#+END_VERSE`
- **居中块**：`#+BEGIN_CENTER` / `#+END_CENTER`

#### 链接（智能样式设计）
- **内部链接**：`[[*标题]]`、`[[#锚点]]`
- **外部链接**：`[[https://example.com][描述]]`
- **文件链接**：`[[file:path/to/file][描述]]`
- **ID链接**：`[[id:XXXXXXXX-XXXX-XXXX-XXXX-XXXXXXXXXXXX][description]]`

**智能链接样式**：
- **URL/引用部分**：保持下划线，表示可点击
- **描述部分**：**加粗显示，无下划线**，突出显示描述文本
- **Hover效果**：鼠标悬停时有背景高亮

#### 属性和指令
- **文档属性**：`#+TITLE:`、`#+AUTHOR:`、`#+DATE:` 等
- **属性配置**：`:ID:`、`:CATEGORY:`、`:PROPERTIES:` 等
- **表格**：完整的表格语法支持
- **数学公式**：行内 `$...$` 和块级 `$$...$$`
- **时间戳**：各种时间格式
- **注释**：以 `#` 开头的注释行
- **水平分隔线**：`-----`

### 增强装饰器高亮

除了基础语法高亮，VOrg 还提供了额外的装饰器高亮，**颜色会根据 VS Code 主题自动调整**：

#### TODO 状态高亮
- **TODO/NEXT/WAITING**：红色系背景高亮
- **DONE/CANCELLED**：绿色系背景高亮

#### 标签高亮
- **彩色标签**：紫色系背景，圆角边框
- **斜体样式**：更好的视觉区分

#### 时间戳高亮
- **背景色**：绿色系背景
- **圆角边框**：现代化外观

#### 链接高亮
- **URL部分**：下划线，蓝色字体，可点击提示
- **描述部分**：加粗显示，无下划线
- **Hover效果**：背景高亮

#### 代码块高亮
- **背景色**：主题适应的背景色
- **左边框**：橙色系边框标识
- **圆角边框**：现代化外观
- **语法高亮**：根据指定语言进行真正的代码高亮

#### 引用块高亮
- **背景色**：绿色系背景
- **左边框**：绿色系边框标识
- **斜体样式**：引用文本样式

#### 表格高亮
- **背景色**：黄色系背景
- **行高亮**：整行高亮显示

#### 数学公式高亮
- **背景色**：紫色系背景
- **圆角边框**：公式块标识

## 主题自适应系统

VOrg 的语法高亮会**自动检测并跟随 VS Code 的当前主题**：

### 深色主题配色
- **TODO关键字**：`#569CD6` (VSCode深色主题的关键字蓝色)
- **DONE关键字**：`#4EC9B0` (VSCode深色主题的类型青色)  
- **属性名**：`#C586C0` (VSCode深色主题的控制流紫色)
- **块关键字**：`#C586C0` (与属性名相同的控制流紫色)
- **指令关键字**：`#6A9955` (低调的注释色调，不抢夺注意力)
- **时间戳**：`#CE9178` (VSCode深色主题的字符串橙色)
- **链接URL**：`#9CDCFE` (带下划线，可点击提示)
- **链接描述**：`#DCDCAA` (加粗显示，无下划线)
- **引用块**：`#6A9955` (VSCode深色主题的注释绿色)

### 浅色主题配色
- **TODO关键字**：`#0000FF` (传统编程语言的关键字蓝色)
- **DONE关键字**：`#008000` (传统编程语言的成功绿色)
- **属性名**：`#800080` (传统编程语言的控制流紫色)
- **块关键字**：`#800080` (与属性名相同的控制流紫色)
- **指令关键字**：`#708090` (低调的灰蓝色，作为配置不抢夺注意力)
- **时间戳**：`#A31515` (传统编程语言的字符串红色)
- **链接URL**：`#0000EE` (带下划线，可点击提示)
- **链接描述**：`#8B4513` (加粗显示，无下划线)

### 实时主题切换
- **无缝切换**：当您切换 VS Code 主题时，语法高亮会立即更新
- **自动检测**：无需手动配置，自动识别主题类型
- **全局同步**：所有打开的 .org 文件都会同步更新

### 支持的主题类型
- **深色主题**：Dark、Dark+、Monokai、Dracula 等
- **浅色主题**：Light、Light+、Quiet Light、Solarized Light 等
- **高对比度主题**：自动识别并提供更高的颜色对比度

## 语法Token映射优化

为了更好地利用 VSCode 主题中的程序语言保留字样式，VOrg 进行了以下优化：

### 属性配置
- **Token类型**：`keyword.control.property.org`
- **效果**：属性名（如`:ID:`、`:CATEGORY:`等）使用与程序语言中控制关键字相同的样式
- **样式**：普通字体，无斜体，保持简洁

### Babel 块关键字
- **Token类型**：`keyword.control.flow.begin.org` 和 `keyword.control.flow.end.org`
- **效果**：`BEGIN_SRC`、`END_SRC`、`BEGIN_QUOTE`、`END_QUOTE`等关键字使用与程序语言中流程控制关键字相同的样式
- **样式**：保持加粗突出，因为它们是结构性元素

### 指令关键字
- **Token类型**：`keyword.control.directive.org`
- **效果**：`#+TITLE:`、`#+AUTHOR:`等指令使用与程序语言中预处理器指令相似的样式
- **样式**：使用低饱和度颜色，无加粗，作为配置项应该低调不抢夺注意力

## 使用方法

### 启用语法高亮

1. **自动启用**：打开 `.org` 文件时自动启用
2. **实时更新**：编辑时自动更新高亮
3. **主题同步**：切换 VS Code 主题时自动更新颜色

### 主题切换体验

1. 打开任何 `.org` 文件
2. 使用 `Ctrl+Shift+P` → "Preferences: Color Theme"
3. 选择任何深色或浅色主题
4. 语法高亮会立即适应新主题！

### 测试语法高亮

可以使用 `test-data/syntax-test.org` 来测试所有的语法高亮效果，该文件包含了：

- 各种属性配置
- **多种编程语言的代码块** (Python, JavaScript, TypeScript, Java, C++, Rust, Go, Shell, SQL, JSON, YAML, HTML, CSS)
- 引用块、示例块等
- 指令关键字
- 时间戳和链接

### 自定义颜色（高级用户）

如需自定义特定颜色，可以在 `settings.json` 中添加：

```json
{
  "editor.tokenColorCustomizations": {
    "textMateRules": [
      {
        "scope": "markup.heading.1.org",
        "settings": {
          "foreground": "#your-custom-color"
        }
      }
    ]
  }
}
```

## 技术实现

### 主题检测机制
- **API**：使用 `vscode.window.activeColorTheme.kind`
- **监听器**：`onDidChangeActiveColorTheme` 事件监听
- **实时更新**：主题变化时立即重新渲染

### 颜色自适应算法
- **深色主题**：使用高亮度、低饱和度颜色
- **浅色主题**：使用中等亮度、高饱和度颜色
- **对比度优化**：确保在不同主题下都有良好的可读性

### TextMate 语法定义
- **文件**：`syntaxes/org.tmLanguage.json`
- **作用域**：`source.org`
- **语法规则**：正则表达式匹配

### 装饰器高亮
- **文件**：`src/syntaxHighlighter.ts`
- **API**：VS Code Decoration API
- **动态颜色**：根据主题类型动态生成颜色
- **专门方法**：
  - `applyPropertiesHighlighting()` - 应用属性高亮
  - `applyBlockKeywordsHighlighting()` - 应用块关键字高亮
  - `applyDirectivesHighlighting()` - 应用指令关键字高亮

### 正则表达式模式
- **属性匹配**：`/^\s*:([A-Z_]+):/`
- **块关键字匹配**：`/^\s*#\+(BEGIN_\w+|END_\w+)/`
- **指令匹配**：`/^\s*#\+(\w+):/`

## 性能优化

### 主题变化优化
- **智能检测**：只在主题真正变化时更新
- **批量更新**：同时更新所有打开的编辑器
- **资源管理**：正确清理和重建装饰器

### 防抖机制
- 避免频繁的语法高亮更新
- 100ms 延迟的防抖处理

### 内存管理
- 单例模式的语法高亮器
- 正确的资源清理和释放

## 样式设计原则

- **属性配置 (PROPERTIES)**：采用普通字体，无斜体，保持简洁
- **指令关键字 (#+TITLE: 等)**：使用低饱和度颜色，无加粗，作为配置项应该低调不抢夺注意力
- **块关键字 (BEGIN_/END_)**：保持加粗突出，因为它们是结构性元素
- **主题适配**：深色和亮色主题都采用低调的配色方案
- **代码块**：支持真正的语法高亮，而不仅仅是原始文本显示
- **链接**：智能样式，URL部分可点击提示，描述部分突出显示

## 故障排除

### 语法高亮不工作
1. 确认文件扩展名为 `.org`
2. 检查语言模式是否为 "Org"
3. 重新加载 VS Code 窗口

### 主题切换不生效
1. 尝试重新打开 .org 文件
2. 检查是否与其他扩展冲突
3. 重启 VS Code

### 颜色显示异常
1. 确认使用的是标准 VS Code 主题
2. 检查是否有自定义的颜色配置冲突
3. 重置用户设置中的颜色自定义

### 代码块语法高亮不工作
1. 确认语言标识符正确（如 `python`、`javascript` 等）
2. 检查是否安装了对应语言的VS Code扩展
3. 对于未支持的语言，会回退到原始文本显示

## 扩展性和未来计划

### 自定义主题适配
可以通过修改 `getThemeColors()` 方法添加对特殊主题的支持。

### 颜色方案扩展
可以为特定主题类型定义专门的颜色方案。

### 主题检测增强
可以添加对更多主题类型的检测和适配。

### 未来功能计划
1. **表格语法增强**：进一步优化表格的语法高亮
2. **数学公式**：改进LaTeX数学公式的显示
3. **自定义标签**：支持用户自定义的TODO关键字和标签样式
4. **动态主题适配**：更精细的主题颜色提取和适配
5. **更多编程语言**：扩展代码块支持的编程语言类型

## 开发者注意事项

- 所有的token类型都遵循VSCode的语法高亮规范
- 颜色配置支持主题切换的动态更新
- 正则表达式经过优化，避免性能问题
- 代码结构清晰，便于后续扩展和维护
- 样式设计遵循"配置低调，结构突出"的原则
- 真正的代码语法高亮通过嵌入语言特性实现

---

VOrg 的智能主题跟随功能和真正的代码语法高亮让您在任何 VS Code 主题下都能获得最佳的 Org-mode 编辑体验！🎨 