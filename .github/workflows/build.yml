name: Build Extension

on:
  push:
    branches:
      - '**' # æ‰€æœ‰åˆ†æ”¯çš„ push éƒ½ä¼šè§¦å‘æž„å»º
  pull_request:
    branches:
      - '**' # PR ä¹Ÿä¼šè§¦å‘æž„å»º

permissions:
  contents: write # éœ€è¦å†™å…¥æƒé™ä»¥åˆ›å»º/æ›´æ–° Release

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # 1. è®¾ç½® pnpm çŽ¯å¢ƒ
      - name: Setup pnpm
        uses: pnpm/action-setup@v3
        with:
          version: 10.19.0 # ä¸Ž package.json ä¸­çš„ packageManager å­—æ®µä¿æŒä¸€è‡´

      # 2. è®¾ç½® Node.js çŽ¯å¢ƒ (ä¸Ž pnpm é…åˆä½¿ç”¨)
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20' # ä½¿ç”¨ Node.js 20 LTS ç‰ˆæœ¬ï¼Œè§£å†³ undici File API å…¼å®¹æ€§é—®é¢˜
          cache: 'pnpm' # ä¸º pnpm è®¾ç½®ç¼“å­˜ï¼ŒåŠ å¿«åŽç»­æž„å»ºé€Ÿåº¦

      - name: Install dependencies
        run: pnpm install --frozen-lockfile # ä½¿ç”¨ pnpm å®‰è£…ä¾èµ–

      # åˆ›å»ºè¾“å‡ºç›®å½•
      - name: Create dist directory
        run: mkdir -p dist

      # æå–æž„å»ºä¿¡æ¯
      - name: Extract build info
        id: build-info
        run: |
          SHORT_SHA=$(echo ${{ github.sha }} | cut -c1-7)
          BRANCH=$(echo ${{ github.ref }} | sed 's/refs\/heads\///' | sed 's/refs\/pull\///' | sed 's/\/merge//' | sed 's/\//-/g')
          echo "short_sha=$SHORT_SHA" >> $GITHUB_OUTPUT
          echo "branch=$BRANCH" >> $GITHUB_OUTPUT
          echo "filename=dist/vorg-9.9.9.vsix" >> $GITHUB_OUTPUT
          echo "release_filename=vorg-9.9.9.vsix" >> $GITHUB_OUTPUT

      # 3. æ‰“åŒ…æ‰©å±•æ–‡ä»¶ï¼ˆvsce package ä¼šè‡ªåŠ¨è¿è¡Œ vscode:prepublish è¿›è¡Œç”Ÿäº§æž„å»ºï¼‰
      # ä½¿ç”¨ --no-dependencies ä¸Ž package.json ä¸­çš„ package è„šæœ¬ä¿æŒä¸€è‡´
      - name: Package Extension
        run: pnpm exec vsce package --out ${{ steps.build-info.outputs.filename }} --no-dependencies

      # å¤åˆ¶æ–‡ä»¶åˆ°æ ¹ç›®å½•ç”¨äºŽ Releaseï¼ˆèŽ·å¾—å›ºå®šä¸‹è½½é“¾æŽ¥ï¼‰
      - name: Copy file for release
        run: cp ${{ steps.build-info.outputs.filename }} ${{ steps.build-info.outputs.release_filename }}

      # 4. ä¸Šä¼  VSIX æ–‡ä»¶ä¸º artifactï¼Œæ–¹ä¾¿åœ¨ Actions é¡µé¢ä¸‹è½½
      - name: Upload VSIX artifact
        uses: actions/upload-artifact@v4
        with:
          name: vorg-extension-${{ steps.build-info.outputs.short_sha }}
          path: ${{ steps.build-info.outputs.filename }}
          retention-days: 30 # ä¿ç•™ 30 å¤©

      # 5. åˆ›å»º/æ›´æ–°å›ºå®šä¸‹è½½é“¾æŽ¥ï¼ˆé€šè¿‡ draft releaseï¼‰
      - name: Create/Update Latest Build Release
        continue-on-error: true # å³ä½¿å¤±è´¥ä¹Ÿä¸å½±å“æž„å»º
        uses: softprops/action-gh-release@v1
        with:
          tag_name: 9.9.9 # å›ºå®š tag åç§°
          name: Latest Build (${{ steps.build-info.outputs.short_sha }})
          body: |
            ## ðŸ“¦ æœ€æ–°æž„å»º
            
            - **åˆ†æ”¯**: ${{ steps.build-info.outputs.branch }}
            - **æäº¤**: ${{ steps.build-info.outputs.short_sha }}
            - **æž„å»ºæ—¶é—´**: ${{ github.event.head_commit.timestamp || github.run_started_at }}
            
            > æ­¤ Release ä¼šåœ¨æ¯æ¬¡æž„å»ºæ—¶è‡ªåŠ¨æ›´æ–°ï¼Œæä¾›å›ºå®šçš„ä¸‹è½½é“¾æŽ¥ã€‚
            
            ### å›ºå®šä¸‹è½½é“¾æŽ¥
            ```
            https://github.com/${{ github.repository }}/releases/download/9.9.9/vorg-9.9.9.vsix
            ```
          draft: false # å¿…é¡»ä¸º false æ‰èƒ½é€šè¿‡ç›´æŽ¥é“¾æŽ¥è®¿é—®
          prerelease: true # æ ‡è®°ä¸ºé¢„å‘å¸ƒç‰ˆæœ¬ï¼Œä¸Žæ­£å¼ç‰ˆæœ¬åŒºåˆ†
          files: ${{ steps.build-info.outputs.release_filename }}
          token: ${{ secrets.GITHUB_TOKEN }}

      # 6. è¾“å‡ºæž„å»ºä¿¡æ¯
      - name: Build Summary
        run: |
          echo "## ðŸ“¦ æž„å»ºå®Œæˆ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **åˆ†æ”¯**: ${{ steps.build-info.outputs.branch }}" >> $GITHUB_STEP_SUMMARY
          echo "- **æäº¤**: ${{ steps.build-info.outputs.short_sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- **æ–‡ä»¶**: \`${{ steps.build-info.outputs.filename }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“¥ ä¸‹è½½æ–¹å¼" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "1. **å›ºå®šä¸‹è½½é“¾æŽ¥**ï¼ˆæŽ¨èï¼‰ï¼š" >> $GITHUB_STEP_SUMMARY
          echo "   \`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "   https://github.com/${{ github.repository }}/releases/download/9.9.9/vorg-9.9.9.vsix" >> $GITHUB_STEP_SUMMARY
          echo "   \`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "2. **Artifact ä¸‹è½½**ï¼šå¯åœ¨ Actions é¡µé¢ä¸‹è½½ artifact" >> $GITHUB_STEP_SUMMARY

